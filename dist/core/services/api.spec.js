"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var _ = require("lodash");
var Rx = require("rx");
var mock_1 = require("../../api/mock");
var base_1 = require("../components/base");
var component_1 = require("../../tests/component");
describe('mock api', function () {
    it('mocks basic queries', function () {
        var mockApi = new mock_1.MockApi();
        var subscriber = jasmine.createSpy('subscriber');
        mockApi.createResource('collection');
        mockApi.Collection.query().subscribe(subscriber);
        expect(subscriber).toHaveBeenCalledTimes(1);
        expect(subscriber.calls.mostRecent().args[0]).toEqual([]);
        // Add an item.
        mockApi.addItem('collection', { id: 1, name: 'Hello world' });
        expect(subscriber).toHaveBeenCalledTimes(2);
        expect(subscriber.calls.mostRecent().args[0]).toEqual([{ id: 1, name: 'Hello world' }]);
        // Update an item.
        mockApi.updateItem('collection', { id: 1, name: 'Hello mockups' });
        expect(subscriber).toHaveBeenCalledTimes(3);
        expect(subscriber.calls.mostRecent().args[0]).toEqual([{ id: 1, name: 'Hello mockups' }]);
        // Remove an item.
        mockApi.removeItem('collection', 1);
        expect(subscriber).toHaveBeenCalledTimes(4);
        expect(subscriber.calls.mostRecent().args[0]).toEqual([]);
    });
    it('mocks complex queries', function () {
        var mockApi = new mock_1.MockApi();
        var subscriberPlain = jasmine.createSpy('subscriberPlain');
        var subscriberWithFilter = jasmine.createSpy('subscriberWithFilter');
        mockApi.createResource('collection', 'id', function (query, items) {
            if (_.isEmpty(query))
                return items;
            return _.filter(items, function (item) { return item.name === query.name; });
        });
        mockApi.Collection.query().subscribe(subscriberPlain);
        mockApi.Collection.query({ name: 'Hello' }).subscribe(subscriberWithFilter);
        mockApi.addItem('collection', { id: 1, name: 'Collection A' });
        mockApi.addItem('collection', { id: 2, name: 'Another one' });
        mockApi.addItem('collection', { id: 3, name: 'Hello' });
        mockApi.addItem('collection', { id: 4, name: 'Hello world' });
        expect(subscriberPlain).toHaveBeenCalledTimes(5);
        expect(subscriberWithFilter).toHaveBeenCalledTimes(2);
    });
    it('mocks non-query operations', function () {
        var mockApi = new mock_1.MockApi();
        var subscriber = jasmine.createSpy('subscriber');
        mockApi.whenPost('/api/collection', subscriber);
        mockApi.Collection.create({ name: 'Foo' });
        expect(subscriber).toHaveBeenCalledTimes(1);
        expect(subscriber.calls.mostRecent().args[0]).toEqual({});
        expect(subscriber.calls.mostRecent().args[1]).toEqual({ name: 'Foo' });
        mockApi.whenPost(/^\/api\/collection\/(.+?)\/add_data/, subscriber);
        mockApi.Collection.addData(1, [1, 2, 3, 4]);
        expect(subscriber).toHaveBeenCalledTimes(2);
        expect(subscriber.calls.mostRecent().args[1]).toEqual({ ids: [1, 2, 3, 4] });
        expect(subscriber.calls.mostRecent().args[2][1]).toEqual('1');
        mockApi.whenGet('/api/collection/slug_exists', function (parameters, data) {
            return parameters.name === 'hello';
        });
        mockApi.Collection.slugExists('bar').subscribe(subscriber);
        expect(subscriber).toHaveBeenCalledTimes(3);
        expect(subscriber.calls.mostRecent().args[0]).toBe(false);
        mockApi.Collection.slugExists('hello').subscribe(subscriber);
        expect(subscriber).toHaveBeenCalledTimes(4);
        expect(subscriber.calls.mostRecent().args[0]).toBe(true);
    });
    it('supports zip operation', function () {
        var mockApi = new mock_1.MockApi();
        var subscriber = jasmine.createSpy('subscriber');
        mockApi.createResource('collection');
        mockApi.addItem('collection', { id: 1 });
        Rx.Observable.zip(mockApi.Collection.query(), mockApi.Collection.query()).subscribe(subscriber);
        expect(subscriber).toHaveBeenCalledTimes(1);
        expect(subscriber.calls.mostRecent().args[0]).toEqual([[{ id: 1 }], [{ id: 1 }]]);
    });
});
component_1.describeComponent('angular mock api', [], function (tester) {
    var TestComponent = (function (_super) {
        __extends(TestComponent, _super);
        // @ngInject
        TestComponent.$inject = ["$scope", "api"];
        function TestComponent($scope, api) {
            var _this = _super.call(this, $scope) || this;
            _this.subscribe('collection', api.Collection.queryOne());
            return _this;
        }
        return TestComponent;
    }(base_1.ComponentBase));
    TestComponent = __decorate([
        base_1.component({
            module: tester.module,
            directive: 'gen-test-component',
            template: "<div class=\"text-name\">Collection name is {{ctrl.collection.name}}</div>",
        })
    ], TestComponent);
    it('replaces api service', function () {
        tester.api().createResource('collection');
        tester.api().addItem('collection', { id: 1, name: 'Hello world' });
        var component = tester.createComponent(TestComponent.asView().template);
        expect(component.ctrl.collection.id).toBe(1);
        expect(component.ctrl.collection.name).toBe('Hello world');
        expect(component.element.find('.text-name').text()).toBe('Collection name is Hello world');
    });
    it('mocks uploads', function (done) {
        var uploaded = false;
        tester.api().whenUpload(function (data, fileUID) {
            uploaded = true;
            return { data: 'hello' };
        });
        tester.api().upload({}, 'test-uuid').then(function (response) {
            expect(uploaded).toEqual(true);
            expect(response.data).toEqual('hello');
            done();
        });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb3JlL3NlcnZpY2VzL2FwaS5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDBCQUE0QjtBQUM1Qix1QkFBeUI7QUFLekIsdUNBQXVDO0FBQ3ZDLDJDQUE0RDtBQUM1RCxtREFBd0Q7QUFLeEQsUUFBUSxDQUFDLFVBQVUsRUFBRTtJQUNqQixFQUFFLENBQUMscUJBQXFCLEVBQUU7UUFDdEIsSUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQztRQUM5QixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRW5ELE9BQU8sQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFckMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUxRCxlQUFlO1FBQ2YsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUMsQ0FBQyxDQUFDO1FBQzVELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBQyxDQUFDLENBQUMsQ0FBQztRQUV0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LENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRW5ELE9BQU8sQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDaEQsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUV6QyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBRXJFLE9BQU8sQ0FBQyxRQUFRLENBQUMscUNBQXFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDcEUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU1QyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1FBQzNFLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxD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QUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDdkMsSUFBSSxFQUFFLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiY29yZS9zZXJ2aWNlcy9hcGkuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIFJ4IGZyb20gJ3J4JztcbmltcG9ydCAqIGFzIGFuZ3VsYXIgZnJvbSAnYW5ndWxhcic7XG5cbmltcG9ydCB7QVBJU2VydmljZUJhc2V9IGZyb20gJy4vYXBpJztcbmltcG9ydCB7UmVzb2x3ZUFwaX0gZnJvbSAnLi4vLi4vYXBpL2luZGV4JztcbmltcG9ydCB7TW9ja0FwaX0gZnJvbSAnLi4vLi4vYXBpL21vY2snO1xuaW1wb3J0IHtjb21wb25lbnQsIENvbXBvbmVudEJhc2V9IGZyb20gJy4uL2NvbXBvbmVudHMvYmFzZSc7XG5pbXBvcnQge2Rlc2NyaWJlQ29tcG9uZW50fSBmcm9tICcuLi8uLi90ZXN0cy9jb21wb25lbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFQSVNlcnZpY2UgZXh0ZW5kcyBBUElTZXJ2aWNlQmFzZSwgUmVzb2x3ZUFwaSB7XG59XG5cbmRlc2NyaWJlKCdtb2NrIGFwaScsICgpID0+IHtcbiAgICBpdCgnbW9ja3MgYmFzaWMgcXVlcmllcycsICgpID0+IHtcbiAgICAgICAgY29uc3QgbW9ja0FwaSA9IG5ldyBNb2NrQXBpKCk7XG4gICAgICAgIGNvbnN0IHN1YnNjcmliZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgnc3Vic2NyaWJlcicpO1xuXG4gICAgICAgIG1vY2tBcGkuY3JlYXRlUmVzb3VyY2UoJ2NvbGxlY3Rpb24nKTtcblxuICAgICAgICBtb2NrQXBpLkNvbGxlY3Rpb24ucXVlcnkoKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0VxdWFsKFtdKTtcblxuICAgICAgICAvLyBBZGQgYW4gaXRlbS5cbiAgICAgICAgbW9ja0FwaS5hZGRJdGVtKCdjb2xsZWN0aW9uJywge2lkOiAxLCBuYW1lOiAnSGVsbG8gd29ybGQnfSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0VxdWFsKFt7aWQ6IDEsIG5hbWU6ICdIZWxsbyB3b3JsZCd9XSk7XG5cbiAgICAgICAgLy8gVXBkYXRlIGFuIGl0ZW0uXG4gICAgICAgIG1vY2tBcGkudXBkYXRlSXRlbSgnY29sbGVjdGlvbicsIHtpZDogMSwgbmFtZTogJ0hlbGxvIG1vY2t1cHMnfSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0VxdWFsKFt7aWQ6IDEsIG5hbWU6ICdIZWxsbyBtb2NrdXBzJ31dKTtcblxuICAgICAgICAvLyBSZW1vdmUgYW4gaXRlbS5cbiAgICAgICAgbW9ja0FwaS5yZW1vdmVJdGVtKCdjb2xsZWN0aW9uJywgMSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoNCk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0VxdWFsKFtdKTtcbiAgICB9KTtcblxuICAgIGl0KCdtb2NrcyBjb21wbGV4IHF1ZXJpZXMnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tBcGkgPSBuZXcgTW9ja0FwaSgpO1xuICAgICAgICBjb25zdCBzdWJzY3JpYmVyUGxhaW4gPSBqYXNtaW5lLmNyZWF0ZVNweSgnc3Vic2NyaWJlclBsYWluJyk7XG4gICAgICAgIGNvbnN0IHN1YnNjcmliZXJXaXRoRmlsdGVyID0gamFzbWluZS5jcmVhdGVTcHkoJ3N1YnNjcmliZXJXaXRoRmlsdGVyJyk7XG5cbiAgICAgICAgbW9ja0FwaS5jcmVhdGVSZXNvdXJjZSgnY29sbGVjdGlvbicsICdpZCcsIChxdWVyeSwgaXRlbXMpID0+IHtcbiAgICAgICAgICAgIGlmIChfLmlzRW1wdHkocXVlcnkpKSByZXR1cm4gaXRlbXM7XG5cbiAgICAgICAgICAgIHJldHVybiBfLmZpbHRlcihpdGVtcywgKGl0ZW06IGFueSkgPT4gaXRlbS5uYW1lID09PSBxdWVyeS5uYW1lKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbW9ja0FwaS5Db2xsZWN0aW9uLnF1ZXJ5KCkuc3Vic2NyaWJlKHN1YnNjcmliZXJQbGFpbik7XG4gICAgICAgIG1vY2tBcGkuQ29sbGVjdGlvbi5xdWVyeSh7bmFtZTogJ0hlbGxvJ30pLnN1YnNjcmliZShzdWJzY3JpYmVyV2l0aEZpbHRlcik7XG5cbiAgICAgICAgbW9ja0FwaS5hZGRJdGVtKCdjb2xsZWN0aW9uJywge2lkOiAxLCBuYW1lOiAnQ29sbGVjdGlvbiBBJ30pO1xuICAgICAgICBtb2NrQXBpLmFkZEl0ZW0oJ2NvbGxlY3Rpb24nLCB7aWQ6IDIsIG5hbWU6ICdBbm90aGVyIG9uZSd9KTtcbiAgICAgICAgbW9ja0FwaS5hZGRJdGVtKCdjb2xsZWN0aW9uJywge2lkOiAzLCBuYW1lOiAnSGVsbG8nfSk7XG4gICAgICAgIG1vY2tBcGkuYWRkSXRlbSgnY29sbGVjdGlvbicsIHtpZDogNCwgbmFtZTogJ0hlbGxvIHdvcmxkJ30pO1xuXG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyUGxhaW4pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcyg1KTtcbiAgICAgICAgZXhwZWN0KHN1YnNjcmliZXJXaXRoRmlsdGVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgfSk7XG5cbiAgICBpdCgnbW9ja3Mgbm9uLXF1ZXJ5IG9wZXJhdGlvbnMnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tBcGkgPSBuZXcgTW9ja0FwaSgpO1xuICAgICAgICBjb25zdCBzdWJzY3JpYmVyID0gamFzbWluZS5jcmVhdGVTcHkoJ3N1YnNjcmliZXInKTtcblxuICAgICAgICBtb2NrQXBpLndoZW5Qb3N0KCcvYXBpL2NvbGxlY3Rpb24nLCBzdWJzY3JpYmVyKTtcbiAgICAgICAgbW9ja0FwaS5Db2xsZWN0aW9uLmNyZWF0ZSh7bmFtZTogJ0Zvbyd9KTtcblxuICAgICAgICBleHBlY3Qoc3Vic2NyaWJlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgICBleHBlY3Qoc3Vic2NyaWJlci5jYWxscy5tb3N0UmVjZW50KCkuYXJnc1swXSkudG9FcXVhbCh7fSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzFdKS50b0VxdWFsKHtuYW1lOiAnRm9vJ30pO1xuXG4gICAgICAgIG1vY2tBcGkud2hlblBvc3QoL15cXC9hcGlcXC9jb2xsZWN0aW9uXFwvKC4rPylcXC9hZGRfZGF0YS8sIHN1YnNjcmliZXIpO1xuICAgICAgICBtb2NrQXBpLkNvbGxlY3Rpb24uYWRkRGF0YSgxLCBbMSwgMiwgMywgNF0pO1xuXG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzFdKS50b0VxdWFsKHtpZHM6IFsxLCAyLCAzLCA0XX0pO1xuICAgICAgICBleHBlY3Qoc3Vic2NyaWJlci5jYWxscy5tb3N0UmVjZW50KCkuYXJnc1syXVsxXSkudG9FcXVhbCgnMScpO1xuXG4gICAgICAgIG1vY2tBcGkud2hlbkdldCgnL2FwaS9jb2xsZWN0aW9uL3NsdWdfZXhpc3RzJywgKHBhcmFtZXRlcnMsIGRhdGEpOiBib29sZWFuID0+IHtcbiAgICAgICAgICAgIHJldHVybiBwYXJhbWV0ZXJzLm5hbWUgPT09ICdoZWxsbyc7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG1vY2tBcGkuQ29sbGVjdGlvbi5zbHVnRXhpc3RzKCdiYXInKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0JlKGZhbHNlKTtcblxuICAgICAgICBtb2NrQXBpLkNvbGxlY3Rpb24uc2x1Z0V4aXN0cygnaGVsbG8nKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoNCk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3N1cHBvcnRzIHppcCBvcGVyYXRpb24nLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vY2tBcGkgPSBuZXcgTW9ja0FwaSgpO1xuICAgICAgICBjb25zdCBzdWJzY3JpYmVyID0gamFzbWluZS5jcmVhdGVTcHkoJ3N1YnNjcmliZXInKTtcblxuICAgICAgICBtb2NrQXBpLmNyZWF0ZVJlc291cmNlKCdjb2xsZWN0aW9uJyk7XG4gICAgICAgIG1vY2tBcGkuYWRkSXRlbSgnY29sbGVjdGlvbicsIHsgaWQ6IDEgfSk7XG5cbiAgICAgICAgUnguT2JzZXJ2YWJsZS56aXAobW9ja0FwaS5Db2xsZWN0aW9uLnF1ZXJ5KCksIG1vY2tBcGkuQ29sbGVjdGlvbi5xdWVyeSgpKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgICAgIGV4cGVjdChzdWJzY3JpYmVyLmNhbGxzLm1vc3RSZWNlbnQoKS5hcmdzWzBdKS50b0VxdWFsKFsgWyB7IGlkOiAxIH0gXSwgWyB7IGlkOiAxIH0gXSBdKTtcbiAgICB9KTtcbn0pO1xuXG5kZXNjcmliZUNvbXBvbmVudCgnYW5ndWxhciBtb2NrIGFwaScsIFtdLCAodGVzdGVyKSA9PiB7XG4gICAgQGNvbXBvbmVudCh7XG4gICAgICAgIG1vZHVsZTogdGVzdGVyLm1vZHVsZSxcbiAgICAgICAgZGlyZWN0aXZlOiAnZ2VuLXRlc3QtY29tcG9uZW50JyxcbiAgICAgICAgdGVtcGxhdGU6IGA8ZGl2IGNsYXNzPVwidGV4dC1uYW1lXCI+Q29sbGVjdGlvbiBuYW1lIGlzIHt7Y3RybC5jb2xsZWN0aW9uLm5hbWV9fTwvZGl2PmAsXG4gICAgfSlcbiAgICBjbGFzcyBUZXN0Q29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50QmFzZSB7XG4gICAgICAgIHB1YmxpYyBjb2xsZWN0aW9uOiBhbnk7XG5cbiAgICAgICAgLy8gQG5nSW5qZWN0XG4gICAgICAgIGNvbnN0cnVjdG9yKCRzY29wZTogYW5ndWxhci5JU2NvcGUsIGFwaTogQVBJU2VydmljZSkge1xuICAgICAgICAgICAgc3VwZXIoJHNjb3BlKTtcblxuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmUoJ2NvbGxlY3Rpb24nLCBhcGkuQ29sbGVjdGlvbi5xdWVyeU9uZSgpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGl0KCdyZXBsYWNlcyBhcGkgc2VydmljZScsICgpID0+IHtcbiAgICAgICAgdGVzdGVyLmFwaSgpLmNyZWF0ZVJlc291cmNlKCdjb2xsZWN0aW9uJyk7XG4gICAgICAgIHRlc3Rlci5hcGkoKS5hZGRJdGVtKCdjb2xsZWN0aW9uJywge2lkOiAxLCBuYW1lOiAnSGVsbG8gd29ybGQnfSk7XG5cbiAgICAgICAgY29uc3QgY29tcG9uZW50ID0gdGVzdGVyLmNyZWF0ZUNvbXBvbmVudDxUZXN0Q29tcG9uZW50PihcbiAgICAgICAgICAgIFRlc3RDb21wb25lbnQuYXNWaWV3KCkudGVtcGxhdGVcbiAgICAgICAgKTtcblxuICAgICAgICBleHBlY3QoY29tcG9uZW50LmN0cmwuY29sbGVjdGlvbi5pZCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KGNvbXBvbmVudC5jdHJsLmNvbGxlY3Rpb24ubmFtZSkudG9CZSgnSGVsbG8gd29ybGQnKTtcbiAgICAgICAgZXhwZWN0KGNvbXBvbmVudC5lbGVtZW50LmZpbmQoJy50ZXh0LW5hbWUnKS50ZXh0KCkpLnRvQmUoJ0NvbGxlY3Rpb24gbmFtZSBpcyBIZWxsbyB3b3JsZCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ21vY2tzIHVwbG9hZHMnLCAoZG9uZSkgPT4ge1xuICAgICAgICBsZXQgdXBsb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgICAgICB0ZXN0ZXIuYXBpKCkud2hlblVwbG9hZCgoZGF0YTogYW55LCBmaWxlVUlEOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHVwbG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiB7ZGF0YTogJ2hlbGxvJ307XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRlc3Rlci5hcGkoKS51cGxvYWQoe30sICd0ZXN0LXV1aWQnKS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHVwbG9hZGVkKS50b0VxdWFsKHRydWUpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmRhdGEpLnRvRXF1YWwoJ2hlbGxvJyk7XG4gICAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXX0=
