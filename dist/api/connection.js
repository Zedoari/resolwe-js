"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var _ = require("lodash");
var jQuery = require("jquery");
var Rx = require("rx");
require("jquery.cookie");
var queryobserver_1 = require("./queryobserver");
var errors_1 = require("./errors");
var random = require("../core/utils/random");
/**
 * An concrete implementation of a connection.
 */
var SimpleConnection = /** @class */ (function () {
    /**
     * Constructs a new connection.
     */
    function SimpleConnection() {
        this._sessionId = random.randomUuid();
        this._observable = null;
        this._requestQueue = [];
        this._isConnectedSubject = new Rx.Subject();
        this._errors = new Rx.Subject();
        this._queryObserverManager = new queryobserver_1.QueryObserverManager(this, this._errors);
    }
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.sessionId = function () {
        return this._sessionId;
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.csrfCookie = function () {
        return jQuery.cookie('csrftoken');
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.connect = function (restUri, websocketUri) {
        var _this = this;
        if (this._observable) {
            console.warn("Attempted to connect an already initialized connection.");
            return;
        }
        this._restUri = restUri;
        this._websocketUri = websocketUri;
        this._observable = Rx.Observable.create(function (observer) {
            var reconnect = _.throttle(function () {
                _this._websocket = new WebSocket(_this._websocketUri + _this._sessionId + '?subscribe-broadcast');
                // Register message and error handlers.
                _this._websocket.onmessage = observer.onNext.bind(observer);
                // Don't handle `onerror` because it doesn't provide any useful information
                // https://www.w3.org/TR/websockets/#concept-websocket-close-fail
                _this._websocket.onopen = function () {
                    _this._processRequests();
                    _this._handleIsConnected(true);
                };
                // Register reconnection handler. We reconnect immediately after the socket gets closed.
                _this._websocket.onclose = function (event) {
                    var error = new errors_1.WebsocketError("Websocket error " + event.code, event);
                    _this._errors.onNext(error);
                    reconnect();
                    _this._handleIsConnected(false);
                };
            }, 5000);
            reconnect();
            // There is no way to unsubscribe as we always want to have the socket connected.
            return _.noop;
        }).publish();
        this._disposableConnection = this._observable.connect();
        // Subscribe to item cache updates.
        this.messages().subscribe(this._queryObserverManager.update.bind(this._queryObserverManager));
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.disconnect = function () {
        this._disposableConnection.dispose();
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.isConnected = function () {
        return this._isConnectedSubject;
    };
    /**
     * Notifies isConnected observers.
     *
     * @param isConnected True if connection established
     */
    SimpleConnection.prototype._handleIsConnected = function (isConnected) {
        if (this._isConnected !== isConnected) {
            this._isConnected = isConnected;
            if (!_.isUndefined(this._isConnectedSubject)) {
                this._isConnectedSubject.onNext(this._isConnected);
            }
        }
    };
    /**
     * Performs a request against the remote server. If the connection has not
     * yet been established, the request is queued.
     *
     * @param request Any function, which returns a promise
     * @return A promise, which is fulfilled when the initial promise is
     */
    SimpleConnection.prototype._request = function (request) {
        var _this = this;
        var promise = new Promise(function (resolve, reject) {
            _this._requestQueue.push({
                request: request,
                resolve: resolve,
                reject: reject,
            });
            if (_this._websocket && _this._websocket.readyState === WebSocket.OPEN) {
                _this._processRequests();
            }
        });
        return promise;
    };
    /**
     * Processes any pending requests.
     */
    SimpleConnection.prototype._processRequests = function () {
        if (!this._requestQueue.length) {
            return;
        }
        for (var _i = 0, _a = this._requestQueue; _i < _a.length; _i++) {
            var request = _a[_i];
            request.request().then(request.resolve, request.reject);
        }
        this._requestQueue = [];
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.createUriFromPath = function (path) {
        return this._restUri + path;
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.get = function (path, parameters) {
        var _this = this;
        if (parameters === void 0) { parameters = {}; }
        if (!_.isEmpty(parameters)) {
            path += '?' + jQuery.param(parameters);
        }
        path = this.createUriFromPath(path);
        return Rx.Observable.fromPromise(this._request(function () {
            var jQueryXHR = jQuery.ajax({
                type: 'get',
                url: path,
                contentType: 'application/json',
                xhrFields: {
                    withCredentials: true,
                },
            });
            _this._interceptErrors(jQueryXHR);
            return jQueryXHR;
        }));
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.post = function (path, data, parameters) {
        if (parameters === void 0) { parameters = {}; }
        return this._update('POST', path, data, parameters);
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.put = function (path, data, parameters) {
        if (parameters === void 0) { parameters = {}; }
        return this._update('PUT', path, data, parameters);
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.patch = function (path, data, parameters) {
        if (parameters === void 0) { parameters = {}; }
        return this._update('PATCH', path, data, parameters);
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.delete = function (path, data, parameters) {
        if (parameters === void 0) { parameters = {}; }
        return this._update('DELETE', path, data, parameters);
    };
    /**
     * Performs a REST API request against the genesis platform backend.
     *
     * @param method Request method
     * @param path Request path
     * @param data Request body
     * @param parameters Request parameters
     * @return An observable that emits the response
     */
    SimpleConnection.prototype._update = function (method, path, data, parameters) {
        var _this = this;
        if (parameters === void 0) { parameters = {}; }
        if (!_.isEmpty(parameters)) {
            path += '?' + jQuery.param(parameters);
        }
        path = this.createUriFromPath(path);
        return Rx.Observable.fromPromise(this._request(function () {
            var jQueryXHR = jQuery.ajax({
                type: method,
                url: path,
                data: JSON.stringify(data),
                contentType: 'application/json',
                xhrFields: {
                    withCredentials: true,
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('X-CSRFToken', _this.csrfCookie());
                },
            });
            _this._interceptErrors(jQueryXHR);
            return jQueryXHR;
        }));
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.messages = function () {
        return this._observable.map(function (event) {
            return JSON.parse(event.data);
        }).filter(function (data) { return data.msg; }).map(function (data) {
            return {
                msg: data.msg,
                observer: data.observer,
                primary_key: data.primary_key,
                order: data.order,
                item: data.item,
            };
        });
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.errors = function () {
        return this._errors;
    };
    /**
     * @inheritdoc
     */
    SimpleConnection.prototype.queryObserverManager = function () {
        return this._queryObserverManager;
    };
    /**
     * Checks XHR and notifies error observers.
     */
    SimpleConnection.prototype._interceptErrors = function (xhr) {
        var _this = this;
        xhr.then(function (response) {
            if (_.has(response, 'error')) {
                var error = new errors_1.APIError(response['error'], response);
                _this._errors.onNext(error);
            }
        });
        xhr.fail(function (jqXHR, textStatus, errorThrown) {
            if (500 <= jqXHR.status && jqXHR.status < 600) {
                var error = new errors_1.APIError(errorThrown, jqXHR);
                _this._errors.onNext(error);
            }
        });
    };
    return SimpleConnection;
}());
exports.SimpleConnection = SimpleConnection;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcGkvY29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDBCQUE0QjtBQUM1QiwrQkFBaUM7QUFDakMsdUJBQXlCO0FBQ3pCLHlCQUF1QjtBQUV2QixpREFBcUQ7QUFDckQsbUNBQWtEO0FBQ2xELDZDQUErQztBQXFJL0M7O0dBRUc7QUFDSDtJQWFJOztPQUVHO0lBQ0g7UUFDSSxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFXLENBQUM7UUFDckQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQVksQ0FBQztRQUMxQyxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxvQ0FBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRDs7T0FFRztJQUNJLG9DQUFTLEdBQWhCO1FBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0kscUNBQVUsR0FBakI7UUFDSSxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxrQ0FBTyxHQUFkLFVBQWUsT0FBZSxFQUFFLFlBQW9CO1FBQXBELGlCQXVDQztRQXRDRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLHlEQUF5RCxDQUFDLENBQUM7WUFDeEUsTUFBTSxDQUFDO1FBQ1gsQ0FBQztRQUVELElBQUksQ0FBQyxRQUFRLEdBQUcsT0FB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QVUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUNqRSxLQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQixDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQUMsS0FBZ0IsRUFBRSxVQUFrQixFQUFFLFdBQW1CO1lBQy9ELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsSUFBTSxLQUFLLEdBQUcsSUFBSSxpQkFBUSxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDL0MsS0FBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNMLHVCQUFDO0FBQUQsQ0E3U0EsQUE2U0MsSUFBQTtBQTdTWSw0Q0FBZ0IiLCJmaWxlIjoiYXBpL2Nvbm5lY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBqUXVlcnkgZnJvbSAnanF1ZXJ5JztcbmltcG9ydCAqIGFzIFJ4IGZyb20gJ3J4JztcbmltcG9ydCAnanF1ZXJ5LmNvb2tpZSc7XG5cbmltcG9ydCB7UXVlcnlPYnNlcnZlck1hbmFnZXJ9IGZyb20gJy4vcXVlcnlvYnNlcnZlcic7XG5pbXBvcnQge0FQSUVycm9yLCBXZWJzb2NrZXRFcnJvcn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0ICogYXMgcmFuZG9tIGZyb20gJy4uL2NvcmUvdXRpbHMvcmFuZG9tJztcblxuLyoqXG4gKiBNZXNzYWdlIGV4Y2hhbmdlZCB2aWEgV2ViU29ja2V0LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2Uge1xuICAgIG1zZzogc3RyaW5nO1xuICAgIG9ic2VydmVyOiBzdHJpbmc7XG4gICAgcHJpbWFyeV9rZXk6IHN0cmluZztcbiAgICBvcmRlcjogbnVtYmVyO1xuICAgIGl0ZW06IHt9O1xufVxuXG4vKipcbiAqIFJlc3BvbnNlIHRvIFJFU1QgQVBJIG9ic2VydmUgcmVxdWVzdHMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlPYnNlcnZlclJlc3BvbnNlIHtcbiAgICBvYnNlcnZlcjogc3RyaW5nO1xuICAgIGl0ZW1zOiBhbnlbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uIHtcbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBzZXJ2ZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdXJpIEdlbmVzaXMgcGxhdGZvcm0gc2VydmVyIFVSSVxuICAgICAqL1xuICAgIGNvbm5lY3QocmVzdFVyaTogc3RyaW5nLCB3ZWJzb2NrZXRVcmk6IHN0cmluZyk7XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZXMgdGhlIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgZGlzY29ubmVjdCgpO1xuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBhbiBvYnNlcnZhYmxlIHRoYXQgZW1pdHMgd2hldGhlciB3ZWJzb2NrZXQgY29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCBvciBub3QuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIEFuIG9ic2VydmFibGUgdGhhdCBlbWl0cyB0cnVlL2ZhbHNlXG4gICAgICovXG4gICAgaXNDb25uZWN0ZWQoKTogUnguT2JzZXJ2YWJsZTxib29sZWFuPjtcblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGEgUkVTVCBBUEkgR0VUIHJlcXVlc3QgYWdhaW5zdCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBiYWNrZW5kLlxuICAgICAqXG4gICAgICogQHBhcmFtIHBhdGggUmVxdWVzdCBwYXRoXG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgUmVxdWVzdCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBBbiBvYnNlcnZhYmxlIHRoYXQgZW1pdHMgdGhlIHJlc3BvbnNlXG4gICAgICovXG4gICAgZ2V0PFQ+KHBhdGg6IHN0cmluZywgcGFyYW1ldGVycz86IHt9KTogUnguT2JzZXJ2YWJsZTxUPjtcblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGEgUkVTVCBBUEkgUE9TVCByZXF1ZXN0IGFnYWluc3QgdGhlIGdlbmVzaXMgcGxhdGZvcm0gYmFja2VuZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBwYXRoIFJlcXVlc3QgcGF0aFxuICAgICAqIEBwYXJhbSBkYXRhIFJlcXVlc3QgYm9keVxuICAgICAqIEBwYXJhbSBwYXJhbWV0ZXJzIFJlcXVlc3QgcGFyYW1ldGVyc1xuICAgICAqIEByZXR1cm4gQW4gb2JzZXJ2YWJsZSB0aGF0IGVtaXRzIHRoZSByZXNwb25zZVxuICAgICAqL1xuICAgIHBvc3Q8VD4ocGF0aDogc3RyaW5nLCBkYXRhOiB7fSwgcGFyYW1ldGVycz86IHt9KTogUnguT2JzZXJ2YWJsZTxUPjtcblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGEgUkVTVCBBUEkgUFVUIHJlcXVlc3QgYWdhaW5zdCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBiYWNrZW5kLlxuICAgICAqXG4gICAgICogQHBhcmFtIHBhdGggUmVxdWVzdCBwYXRoXG4gICAgICogQHBhcmFtIGRhdGEgUmVxdWVzdCBib2R5XG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgUmVxdWVzdCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBBbiBvYnNlcnZhYmxlIHRoYXQgZW1pdHMgdGhlIHJlc3BvbnNlXG4gICAgICovXG4gICAgcHV0PFQ+KHBhdGg6IHN0cmluZywgZGF0YToge30sIHBhcmFtZXRlcnM/OiB7fSk6IFJ4Lk9ic2VydmFibGU8VD47XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtcyBhIFJFU1QgQVBJIFBBVENIIHJlcXVlc3QgYWdhaW5zdCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBiYWNrZW5kLlxuICAgICAqXG4gICAgICogQHBhcmFtIHBhdGggUmVxdWVzdCBwYXRoXG4gICAgICogQHBhcmFtIGRhdGEgUmVxdWVzdCBib2R5XG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgUmVxdWVzdCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBBbiBvYnNlcnZhYmxlIHRoYXQgZW1pdHMgdGhlIHJlc3BvbnNlXG4gICAgICovXG4gICAgcGF0Y2g8VD4ocGF0aDogc3RyaW5nLCBkYXRhOiB7fSwgcGFyYW1ldGVycz86IHt9KTogUnguT2JzZXJ2YWJsZTxUPjtcblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGEgUkVTVCBBUEkgREVMRVRFIHJlcXVlc3QgYWdhaW5zdCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBiYWNrZW5kLlxuICAgICAqXG4gICAgICogQHBhcmFtIHBhdGggUmVxdWVzdCBwYXRoXG4gICAgICogQHBhcmFtIGRhdGEgUmVxdWVzdCBib2R5XG4gICAgICogQHBhcmFtIHBhcmFtZXRlcnMgUmVxdWVzdCBwYXJhbWV0ZXJzXG4gICAgICogQHJldHVybiBBbiBvYnNlcnZhYmxlIHRoYXQgZW1pdHMgdGhlIHJlc3BvbnNlXG4gICAgICovXG4gICAgZGVsZXRlPFQ+KHBhdGg6IHN0cmluZywgZGF0YToge30sIHBhcmFtZXRlcnM/OiB7fSk6IFJ4Lk9ic2VydmFibGU8VD47XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGFuIGFic29sdXRlIEFQSSBVUkkgZm9yIGEgc3BlY2lmaWMgcmVzb3VyY2UgcGF0aC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBwYXRoIEFQSSByZXNvdXJjZSBwYXRoXG4gICAgICogQHJldHVybiBBYnNvbHV0ZSBVUklcbiAgICAgKi9cbiAgICBjcmVhdGVVcmlGcm9tUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBDU1JGIGNvb2tpZSB2YWx1ZSB0aGF0IG11c3QgYmUgdXNlZCB3aGVuIGRvaW5nIFBPU1QgcmVxdWVzdHMuXG4gICAgICovXG4gICAgY3NyZkNvb2tpZSgpOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBIHN0cmVhbSBvZiBpbmNvbWluZyBXZWJTb2NrZXQgbWVzc2FnZXMuXG4gICAgICovXG4gICAgbWVzc2FnZXMoKTogUnguT2JzZXJ2YWJsZTxNZXNzYWdlPjtcblxuICAgIC8qKlxuICAgICAqIEEgc3RyZWFtIG9mIGVycm9yIG1lc3NhZ2VzLlxuICAgICAqL1xuICAgIGVycm9ycygpOiBSeC5PYnNlcnZhYmxlPEFQSUVycm9yPjtcblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgdW5pcXVlIHNlc3Npb24gaWRlbnRpZmllci5cbiAgICAgKi9cbiAgICBzZXNzaW9uSWQoKTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgUXVlcnlPYnNlcnZlck1hbmFnZXIgaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIHRoaXMgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBxdWVyeU9ic2VydmVyTWFuYWdlcigpOiBRdWVyeU9ic2VydmVyTWFuYWdlcjtcbn1cblxuLyoqXG4gKiBBIHBlbmRpbmcgcmVxdWVzdCB0aGF0IHNob3VsZCBiZSBleGVjdXRlZCBvbmNlIHRoZSBjb25uZWN0aW9uIGlzIGluIGEgcHJvcGVyIHN0YXRlLlxuICovXG5pbnRlcmZhY2UgUGVuZGluZ1JlcXVlc3Qge1xuICAgIHJlcXVlc3Q6ICgpID0+IFJ4LklQcm9taXNlPGFueT47XG4gICAgcmVzb2x2ZTogKHZhbHVlOiBhbnkpID0+IHZvaWQ7XG4gICAgcmVqZWN0OiAocmVhc29uOiBhbnkpID0+IHZvaWQ7XG59XG5cbi8qKlxuICogQW4gY29uY3JldGUgaW1wbGVtZW50YXRpb24gb2YgYSBjb25uZWN0aW9uLlxuICovXG5leHBvcnQgY2xhc3MgU2ltcGxlQ29ubmVjdGlvbiBpbXBsZW1lbnRzIENvbm5lY3Rpb24ge1xuICAgIHByaXZhdGUgX3Jlc3RVcmk6IHN0cmluZztcbiAgICBwcml2YXRlIF93ZWJzb2NrZXRVcmk6IHN0cmluZztcbiAgICBwcml2YXRlIF9zZXNzaW9uSWQ6IHN0cmluZztcbiAgICBwcml2YXRlIF93ZWJzb2NrZXQ6IFdlYlNvY2tldDtcbiAgICBwcml2YXRlIF9vYnNlcnZhYmxlOiBSeC5Db25uZWN0YWJsZU9ic2VydmFibGU8YW55PjtcbiAgICBwcml2YXRlIF9kaXNwb3NhYmxlQ29ubmVjdGlvbjogUnguRGlzcG9zYWJsZTtcbiAgICBwcml2YXRlIF9xdWVyeU9ic2VydmVyTWFuYWdlcjogUXVlcnlPYnNlcnZlck1hbmFnZXI7XG4gICAgcHJpdmF0ZSBfcmVxdWVzdFF1ZXVlOiBQZW5kaW5nUmVxdWVzdFtdO1xuICAgIHByaXZhdGUgX2lzQ29ubmVjdGVkOiBib29sZWFuO1xuICAgIHByaXZhdGUgX2lzQ29ubmVjdGVkU3ViamVjdDogUnguU3ViamVjdDxib29sZWFuPjtcbiAgICBwcml2YXRlIF9lcnJvcnM6IFJ4LlN1YmplY3Q8QVBJRXJyb3I+O1xuXG4gICAgLyoqXG4gICAgICogQ29uc3RydWN0cyBhIG5ldyBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLl9zZXNzaW9uSWQgPSByYW5kb20ucmFuZG9tVXVpZCgpO1xuICAgICAgICB0aGlzLl9vYnNlcnZhYmxlID0gbnVsbDtcbiAgICAgICAgdGhpcy5fcmVxdWVzdFF1ZXVlID0gW107XG4gICAgICAgIHRoaXMuX2lzQ29ubmVjdGVkU3ViamVjdCA9IG5ldyBSeC5TdWJqZWN0PGJvb2xlYW4+KCk7XG4gICAgICAgIHRoaXMuX2Vycm9ycyA9IG5ldyBSeC5TdWJqZWN0PEFQSUVycm9yPigpO1xuICAgICAgICB0aGlzLl9xdWVyeU9ic2VydmVyTWFuYWdlciA9IG5ldyBRdWVyeU9ic2VydmVyTWFuYWdlcih0aGlzLCB0aGlzLl9lcnJvcnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIHNlc3Npb25JZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2Vzc2lvbklkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIGNzcmZDb29raWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGpRdWVyeS5jb29raWUoJ2NzcmZ0b2tlbicpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIGNvbm5lY3QocmVzdFVyaTogc3RyaW5nLCB3ZWJzb2NrZXRVcmk6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5fb2JzZXJ2YWJsZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiQXR0ZW1wdGVkIHRvIGNvbm5lY3QgYW4gYWxyZWFkeSBpbml0aWFsaXplZCBjb25uZWN0aW9uLlwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3Jlc3RVcmkgPSByZXN0VXJpO1xuICAgICAgICB0aGlzLl93ZWJzb2NrZXRVcmkgPSB3ZWJzb2NrZXRVcmk7XG5cbiAgICAgICAgdGhpcy5fb2JzZXJ2YWJsZSA9IFJ4Lk9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVjb25uZWN0ID0gXy50aHJvdHRsZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fd2Vic29ja2V0ID0gbmV3IFdlYlNvY2tldCh0aGlzLl93ZWJzb2NrZXRVcmkgKyB0aGlzLl9zZXNzaW9uSWQgKyAnP3N1YnNjcmliZS1icm9hZGNhc3QnKTtcblxuICAgICAgICAgICAgICAgIC8vIFJlZ2lzdGVyIG1lc3NhZ2UgYW5kIGVycm9yIGhhbmRsZXJzLlxuICAgICAgICAgICAgICAgIHRoaXMuX3dlYnNvY2tldC5vbm1lc3NhZ2UgPSBvYnNlcnZlci5vbk5leHQuYmluZChvYnNlcnZlcik7XG4gICAgICAgICAgICAgICAgLy8gRG9uJ3QgaGFuZGxlIGBvbmVycm9yYCBiZWNhdXNlIGl0IGRvZXNuJ3QgcHJvdmlkZSBhbnkgdXNlZnVsIGluZm9ybWF0aW9uXG4gICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL3dlYnNvY2tldHMvI2NvbmNlcHQtd2Vic29ja2V0LWNsb3NlLWZhaWxcbiAgICAgICAgICAgICAgICB0aGlzLl93ZWJzb2NrZXQub25vcGVuID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzUmVxdWVzdHMoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlSXNDb25uZWN0ZWQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAvLyBSZWdpc3RlciByZWNvbm5lY3Rpb24gaGFuZGxlci4gV2UgcmVjb25uZWN0IGltbWVkaWF0ZWx5IGFmdGVyIHRoZSBzb2NrZXQgZ2V0cyBjbG9zZWQuXG4gICAgICAgICAgICAgICAgdGhpcy5fd2Vic29ja2V0Lm9uY2xvc2UgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgV2Vic29ja2V0RXJyb3IoYFdlYnNvY2tldCBlcnJvciAke2V2ZW50LmNvZGV9YCwgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvcnMub25OZXh0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgcmVjb25uZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZUlzQ29ubmVjdGVkKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSwgNTAwMCk7XG5cbiAgICAgICAgICAgIHJlY29ubmVjdCgpO1xuXG4gICAgICAgICAgICAvLyBUaGVyZSBpcyBubyB3YXkgdG8gdW5zdWJzY3JpYmUgYXMgd2UgYWx3YXlzIHdhbnQgdG8gaGF2ZSB0aGUgc29ja2V0IGNvbm5lY3RlZC5cbiAgICAgICAgICAgIHJldHVybiBfLm5vb3A7XG4gICAgICAgIH0pLnB1Ymxpc2goKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZUNvbm5lY3Rpb24gPSB0aGlzLl9vYnNlcnZhYmxlLmNvbm5lY3QoKTtcblxuICAgICAgICAvLyBTdWJzY3JpYmUgdG8gaXRlbSBjYWNoZSB1cGRhdGVzLlxuICAgICAgICB0aGlzLm1lc3NhZ2VzKCkuc3Vic2NyaWJlKHRoaXMuX3F1ZXJ5T2JzZXJ2ZXJNYW5hZ2VyLnVwZGF0ZS5iaW5kKHRoaXMuX3F1ZXJ5T2JzZXJ2ZXJNYW5hZ2VyKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGluaGVyaXRkb2NcbiAgICAgKi9cbiAgICBwdWJsaWMgZGlzY29ubmVjdCgpIHtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZUNvbm5lY3Rpb24uZGlzcG9zZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIGlzQ29ubmVjdGVkKCk6IFJ4Lk9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXNDb25uZWN0ZWRTdWJqZWN0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE5vdGlmaWVzIGlzQ29ubmVjdGVkIG9ic2VydmVycy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBpc0Nvbm5lY3RlZCBUcnVlIGlmIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWRcbiAgICAgKi9cbiAgICBwcml2YXRlIF9oYW5kbGVJc0Nvbm5lY3RlZChpc0Nvbm5lY3RlZDogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5faXNDb25uZWN0ZWQgIT09IGlzQ29ubmVjdGVkKSB7XG4gICAgICAgICAgICB0aGlzLl9pc0Nvbm5lY3RlZCA9IGlzQ29ubmVjdGVkO1xuICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuX2lzQ29ubmVjdGVkU3ViamVjdCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pc0Nvbm5lY3RlZFN1YmplY3Qub25OZXh0KHRoaXMuX2lzQ29ubmVjdGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm1zIGEgcmVxdWVzdCBhZ2FpbnN0IHRoZSByZW1vdGUgc2VydmVyLiBJZiB0aGUgY29ubmVjdGlvbiBoYXMgbm90XG4gICAgICogeWV0IGJlZW4gZXN0YWJsaXNoZWQsIHRoZSByZXF1ZXN0IGlzIHF1ZXVlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSByZXF1ZXN0IEFueSBmdW5jdGlvbiwgd2hpY2ggcmV0dXJucyBhIHByb21pc2VcbiAgICAgKiBAcmV0dXJuIEEgcHJvbWlzZSwgd2hpY2ggaXMgZnVsZmlsbGVkIHdoZW4gdGhlIGluaXRpYWwgcHJvbWlzZSBpc1xuICAgICAqL1xuICAgIHByaXZhdGUgX3JlcXVlc3QocmVxdWVzdDogKCkgPT4gUnguSVByb21pc2U8YW55Pik6IFJ4LklQcm9taXNlPGFueT4ge1xuICAgICAgICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RRdWV1ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiByZXF1ZXN0LFxuICAgICAgICAgICAgICAgIHJlc29sdmU6IHJlc29sdmUsXG4gICAgICAgICAgICAgICAgcmVqZWN0OiByZWplY3QsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX3dlYnNvY2tldCAmJiB0aGlzLl93ZWJzb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzUmVxdWVzdHMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJvY2Vzc2VzIGFueSBwZW5kaW5nIHJlcXVlc3RzLlxuICAgICAqL1xuICAgIHByaXZhdGUgX3Byb2Nlc3NSZXF1ZXN0cygpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9yZXF1ZXN0UXVldWUubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCByZXF1ZXN0IG9mIHRoaXMuX3JlcXVlc3RRdWV1ZSkge1xuICAgICAgICAgICAgcmVxdWVzdC5yZXF1ZXN0KCkudGhlbihyZXF1ZXN0LnJlc29sdmUsIHJlcXVlc3QucmVqZWN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3JlcXVlc3RRdWV1ZSA9IFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIGNyZWF0ZVVyaUZyb21QYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZXN0VXJpICsgcGF0aDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW5oZXJpdGRvY1xuICAgICAqL1xuICAgIHB1YmxpYyBnZXQocGF0aDogc3RyaW5nLCBwYXJhbWV0ZXJzOiB7fSA9IHt9KTogUnguT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkocGFyYW1ldGVycykpIHtcbiAgICAgICAgICAgIHBhdGggKz0gJz8nICsgalF1ZXJ5LnBhcmFtKHBhcmFtZXRlcnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcGF0aCA9IHRoaXMuY3JlYXRlVXJpRnJvbVBhdGgocGF0aCk7XG5cbiAgICAgICAgcmV0dXJuIFJ4Lk9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5fcmVxdWVzdCgoKTogUnguSVByb21pc2U8YW55PiA9PiB7XG4gICAgICAgICAgICBjb25zdCBqUXVlcnlYSFIgPSBqUXVlcnkuYWpheCh7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2dldCcsXG4gICAgICAgICAgICAgICAgdXJsOiBwYXRoLFxuICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAgICAgeGhyRmllbGRzOiB7XG4gICAgICAgICAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2ludGVyY2VwdEVycm9ycyhqUXVlcnlYSFIpO1xuXG4gICAgICAgICAgICByZXR1cm4galF1ZXJ5WEhSO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGluaGVyaXRkb2NcbiAgICAgKi9cbiAgICBwdWJsaWMgcG9zdChwYXRoOiBzdHJpbmcsIGRhdGE6IHt9LCBwYXJhbWV0ZXJzOiB7fSA9IHt9KTogUnguT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZSgnUE9TVCcsIHBhdGgsIGRhdGEsIHBhcmFtZXRlcnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIHB1dChwYXRoOiBzdHJpbmcsIGRhdGE6IHt9LCBwYXJhbWV0ZXJzOiB7fSA9IHt9KTogUnguT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZSgnUFVUJywgcGF0aCwgZGF0YSwgcGFyYW1ldGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGluaGVyaXRkb2NcbiAgICAgKi9cbiAgICBwdWJsaWMgcGF0Y2gocGF0aDogc3RyaW5nLCBkYXRhOiB7fSwgcGFyYW1ldGVyczoge30gPSB7fSk6IFJ4Lk9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl91cGRhdGUoJ1BBVENIJywgcGF0aCwgZGF0YSwgcGFyYW1ldGVycyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGluaGVyaXRkb2NcbiAgICAgKi9cbiAgICBwdWJsaWMgZGVsZXRlKHBhdGg6IHN0cmluZywgZGF0YToge30sIHBhcmFtZXRlcnM6IHt9ID0ge30pOiBSeC5PYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlKCdERUxFVEUnLCBwYXRoLCBkYXRhLCBwYXJhbWV0ZXJzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtcyBhIFJFU1QgQVBJIHJlcXVlc3QgYWdhaW5zdCB0aGUgZ2VuZXNpcyBwbGF0Zm9ybSBiYWNrZW5kLlxuICAgICAqXG4gICAgICogQHBhcmFtIG1ldGhvZCBSZXF1ZXN0IG1ldGhvZFxuICAgICAqIEBwYXJhbSBwYXRoIFJlcXVlc3QgcGF0aFxuICAgICAqIEBwYXJhbSBkYXRhIFJlcXVlc3QgYm9keVxuICAgICAqIEBwYXJhbSBwYXJhbWV0ZXJzIFJlcXVlc3QgcGFyYW1ldGVyc1xuICAgICAqIEByZXR1cm4gQW4gb2JzZXJ2YWJsZSB0aGF0IGVtaXRzIHRoZSByZXNwb25zZVxuICAgICAqL1xuICAgIHByaXZhdGUgX3VwZGF0ZShtZXRob2Q6IHN0cmluZywgcGF0aDogc3RyaW5nLCBkYXRhOiB7fSwgcGFyYW1ldGVyczoge30gPSB7fSk6IFJ4Lk9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGlmICghXy5pc0VtcHR5KHBhcmFtZXRlcnMpKSB7XG4gICAgICAgICAgICBwYXRoICs9ICc/JyArIGpRdWVyeS5wYXJhbShwYXJhbWV0ZXJzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBhdGggPSB0aGlzLmNyZWF0ZVVyaUZyb21QYXRoKHBhdGgpO1xuXG4gICAgICAgIHJldHVybiBSeC5PYnNlcnZhYmxlLmZyb21Qcm9taXNlKHRoaXMuX3JlcXVlc3QoKCk6IFJ4LklQcm9taXNlPGFueT4gPT4ge1xuICAgICAgICAgICAgY29uc3QgalF1ZXJ5WEhSID0galF1ZXJ5LmFqYXgoe1xuICAgICAgICAgICAgICAgIHR5cGU6IG1ldGhvZCxcbiAgICAgICAgICAgICAgICB1cmw6IHBhdGgsXG4gICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSksXG4gICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgICAgICB4aHJGaWVsZHM6IHtcbiAgICAgICAgICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogKHhociwgc2V0dGluZ3MpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtQ1NSRlRva2VuJywgdGhpcy5jc3JmQ29va2llKCkpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5faW50ZXJjZXB0RXJyb3JzKGpRdWVyeVhIUik7XG5cbiAgICAgICAgICAgIHJldHVybiBqUXVlcnlYSFI7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW5oZXJpdGRvY1xuICAgICAqL1xuICAgIHB1YmxpYyBtZXNzYWdlcygpOiBSeC5PYnNlcnZhYmxlPE1lc3NhZ2U+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX29ic2VydmFibGUubWFwKFxuICAgICAgICAgICAgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICkuZmlsdGVyKFxuICAgICAgICAgICAgKGRhdGEpID0+IGRhdGEubXNnXG4gICAgICAgICkubWFwKFxuICAgICAgICAgICAgKGRhdGEpOiBNZXNzYWdlID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBtc2c6IGRhdGEubXNnLFxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlcjogZGF0YS5vYnNlcnZlcixcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeV9rZXk6IGRhdGEucHJpbWFyeV9rZXksXG4gICAgICAgICAgICAgICAgICAgIG9yZGVyOiBkYXRhLm9yZGVyLFxuICAgICAgICAgICAgICAgICAgICBpdGVtOiBkYXRhLml0ZW0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaW5oZXJpdGRvY1xuICAgICAqL1xuICAgIHB1YmxpYyBlcnJvcnMoKTogUnguT2JzZXJ2YWJsZTxBUElFcnJvcj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXJyb3JzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0ZG9jXG4gICAgICovXG4gICAgcHVibGljIHF1ZXJ5T2JzZXJ2ZXJNYW5hZ2VyKCk6IFF1ZXJ5T2JzZXJ2ZXJNYW5hZ2VyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3F1ZXJ5T2JzZXJ2ZXJNYW5hZ2VyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBYSFIgYW5kIG5vdGlmaWVzIGVycm9yIG9ic2VydmVycy5cbiAgICAgKi9cbiAgICBwcml2YXRlIF9pbnRlcmNlcHRFcnJvcnMoeGhyOiBKUXVlcnlYSFIpOiB2b2lkIHtcbiAgICAgICAgeGhyLnRoZW4oKHJlc3BvbnNlOiB7fSkgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaGFzKHJlc3BvbnNlLCAnZXJyb3InKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IEFQSUVycm9yKDxzdHJpbmc+IHJlc3BvbnNlWydlcnJvciddLCByZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fZXJyb3JzLm9uTmV4dChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHhoci5mYWlsKChqcVhIUjogSlF1ZXJ5WEhSLCB0ZXh0U3RhdHVzOiBzdHJpbmcsIGVycm9yVGhyb3duOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmICg1MDAgPD0ganFYSFIuc3RhdHVzICYmIGpxWEhSLnN0YXR1cyA8IDYwMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IEFQSUVycm9yKGVycm9yVGhyb3duLCBqcVhIUik7XG4gICAgICAgICAgICAgICAgdGhpcy5fZXJyb3JzLm9uTmV4dChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==
